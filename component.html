<polymer-element name="ceci-select" extends="ceci-element"
  attributes="collection firstOption" collection="" firstOption="Choose...">
  <ceci-definition>
    {
      "name": "Select",
      "tags": "select,data,menu,options",
      "thumbnail": "./thumbnail.png",
      "description": "Presents a menu of options",
      "broadcasts": {
        "optionselected": {
          "label": "Selected option",
          "description": "Broadcasts the selected option."
        }
      },
      "listeners": {
      },
      "attributes": {
        "collection": {
          "description": "Collection where the options are stored",
          "label": "Collection"
        },
        "firstOption": {
          "description": "First option of the component",
          "label": "First option"
        }
      }
    }
  </ceci-definition>
  <template>
    <link rel="stylesheet" href="component.css">
    <div class="Select">
      <div class="Select-help js-toggle-visibility">
        <h3>How to add options?</h3>
        <p>The options of the menu are stored in a collection named "Select".</p>
        <p>Edit these in the sidebar's App Data tab.</p>
        <button on-click="{{closeHelp}}" type="button">I understand!</button>
      </div>
      <select class="Select-element u-hidden js-toggle-visibility" on-change="{{selectOption}}">
        <template repeat="{{option in options}}">
          <option value="{{option.value}}">{{option.value}}</option>
        </template>
      </select>
    </div>
    <shadow></shadow>
  </template>
  <script>
    Polymer('ceci-select', {
      ready: function() {
        this.super();
        this.options = [];
        this.collections = document.querySelector('ceci-collections');
      },
      collectionReady: function () {
        var options = this.options;
        var collection = this.collections.getCollection(this.collection);
        collection.addField('value', 'text');

        this.onItemChange = function(e) {
          var detail = e.detail;
          if (detail.removed) {
            options.splice(detail.index, 1);
          }
          if (detail.added) {
            options.splice(detail.index, 0, detail.added);
          }
        };
        collection.addEventListener('itemchange', this.onItemChange);

        if (this.firstOption) {
          collection.addItem({
            value: this.firstOption
          });
        }
      },
      collectionChanged: function() {
        if (this.collection === '') {
          return;
        }
        var collection = this.collections.getCollection(this.collection);
        if (!collection) {
          this.collections.addCollection(this.collection);
        }
        this.async(this.collectionReady);
      },
      selectOption: function (event, detail, sender) {
        this.broadcast('optionselected', sender.value);
      },
      closeHelp: function () {
        var toggleble = this.shadowRoot.querySelectorAll('.js-toggle-visibility');
        [].slice.call(toggleble).forEach(function (el) {
          el.classList.toggle('u-hidden');
        });

        this.collection = 'Select';
      }
    });
  </script>
</polymer-element>
